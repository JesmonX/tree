<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Advanced Folder Tree Viewer</title>
<style>
    body {
        font-family: Menlo, Consolas, monospace;
        background: #f4f4f4;
        padding: 20px;
    }
    ul {
        list-style-type: none;
        padding-left: 20px;
    }
    li {
        line-height: 22px;
        cursor: pointer;
    }
    .folder::before { content: "ğŸ“ "; }
    .file::before   { content: "ğŸ“„ "; }

    #chooseBtn {
        padding: 15px 20px;
        background: #ddd;
        border-radius: 8px;
        cursor: pointer;
        display: inline-block;
    }

    .hidden {
        display: none;
    }
</style>
</head>

<body>

<h2>ğŸ“ Folder Tree Viewer (File System Access API)</h2>

<div id="chooseBtn">ğŸ‘‰ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶å¤¹</div>

<div style="margin-top: 20px;">
    <button id="onlyFoldersBtn">åªæ˜¾ç¤ºæ–‡ä»¶å¤¹</button>
    <button id="showAllBtn">æ˜¾ç¤ºå…¨éƒ¨</button>
</div>

<div id="tree"></div>

<script>
let FULL_TREE = null;

// ----------------------------
// é€‰æ‹©æ–‡ä»¶å¤¹
// ----------------------------
document.getElementById("chooseBtn").onclick = async () => {
    try {
        const dirHandle = await window.showDirectoryPicker();
        FULL_TREE = await readDirectory(dirHandle);
        renderTree(FULL_TREE, false); // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰å†…å®¹
    } catch (err) {
        alert("é€‰æ‹©æ–‡ä»¶å¤¹å¤±è´¥æˆ–å–æ¶ˆæˆæƒ");
    }
};


// ----------------------------
// é€’å½’è¯»å–ç›®å½•ï¼ˆæœ€å¼ºæ–¹æ¡ˆï¼‰
// ----------------------------
async function readDirectory(dirHandle) {
    const node = {
        name: dirHandle.name,
        children: [],
        isFile: false
    };

    for await (const entry of dirHandle.values()) {
        if (entry.kind === "directory") {
            node.children.push(await readDirectory(entry));
        } else {
            node.children.push({
                name: entry.name,
                isFile: true,
                children: []
            });
        }
    }

    // æ’åºï¼šæ–‡ä»¶å¤¹åœ¨å‰
    node.children.sort((a, b) => {
        if (a.isFile === b.isFile) return a.name.localeCompare(b.name);
        return a.isFile ? 1 : -1;
    });

    return node;
}


// ----------------------------
// æ¸²æŸ“ç›®å½•æ ‘
// ----------------------------
function renderTree(root, foldersOnly) {
    const container = document.getElementById("tree");
    container.innerHTML = "";

    function buildList(node) {
        const ul = document.createElement("ul");

        for (const child of node.children) {
            if (foldersOnly && child.isFile) continue;

            const li = document.createElement("li");
            li.textContent = child.name;
            li.className = child.isFile ? "file" : "folder";

            const childUl = buildList(child);
            li.appendChild(childUl);

            if (!child.isFile) {
                li.onclick = function(e) {
                    e.stopPropagation();
                    childUl.style.display =
                        childUl.style.display === "none" ? "block" : "none";
                };
            }

            ul.appendChild(li);
        }

        return ul;
    }

    container.appendChild(buildList(root));
}


// ----------------------------
// æŒ‰é’®ï¼šåªæ˜¾ç¤ºæ–‡ä»¶å¤¹
// ----------------------------
document.getElementById("onlyFoldersBtn").onclick = () => {
    if (FULL_TREE) renderTree(FULL_TREE, true);
};

// ----------------------------
// æŒ‰é’®ï¼šæ˜¾ç¤ºå…¨éƒ¨
// ----------------------------
document.getElementById("showAllBtn").onclick = () => {
    if (FULL_TREE) renderTree(FULL_TREE, false);
};

</script>

</body>
</html>
